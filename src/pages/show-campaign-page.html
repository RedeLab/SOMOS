<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-storage-ref.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../app-elements/app-form-header.html">
<link rel="import" href="../campaign-elements/campaign-player.html">
<link rel="import" href="../app-elements/shared-styles.html">

<dom-module id="show-campaign-page">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        background: var(--primary-background-color);
        height: 100vh;
        --layer-image: '';
        @apply --default-font;
      }
      app-header {
        height: 222px;
        color: var(--light-text-color);
        /* https://bugs.chromium.org/p/chromium/issues/detail?id=637072 */
        --app-header-background-front-layer: {
          background-image: var(--layer-image);
          background-position: center;
          background-size: 125%;
          background-color: grey;
          filter: contrast(.7) brightness(.6);
        };
      }
      campaign-player {
        margin: auto;
      }
      app-header[shadow] {
        color: black;
      }
      app-header[shadow] .tall {
        background: unset;
        width: 100px;
      }
      app-header[shadow] .tall .actions {
        display: none;
      }
      .tall {
        height: 158px;
      }
      .tall .actions {
        position: absolute;
        bottom: 5px;
        right: 5px;
      }
      h1.title[main-title] {
        margin: 5px 20px;
      }
      .fill {
        padding: 0 20px;
        color: var(--secondary-text-color);
      }
      .row:nth-child(5) {
        margin: 10px 0;
      }
      .row span {
        display: block;
      }
      .candidate-info  {
        display: flex;
        align-items: center;
        font-size: 14px;
      }
      .row .col span:first-child {
        font-weight: bold;
        color: var(--dark-primary-color);
      }
      .row .col span:not(:first-child) {
        font-size: 14px;
        color: var(--dark-primary-color);
        font-weight: bold;
      }
      h6 {
        margin: 0;
      }
      h4 {
        color: var(--dark-primary-color);
      }
      .main {
        text-align: center;
        margin-bottom: 20px;
      }
      .details {
        flex: 1;
        line-height: 1;
        margin: 10px 0;
      }
      .details span {
        display: block;
      }
      .support {
        display: inherit;
      }
      .support span {
        margin-right: 15px;
      }
      .support paper-toggle-button {
        transform: scale(1.5);
      }
      .row {
        display: flex;
        margin: 20px 0;
      }
      .row .col {
        flex: 1;
        text-align: center;
        line-height: 1;
        margin-right: 5px;
      }
      .col span:first-child {
        font-size: 28px;
      }
      .description {
        margin-bottom: 35px;
      }
      .social,
      .calendar,
      .ratings,
      .administrators {
        margin-bottom: 5px;
        background-color: var(--secondary-background-color);
        padding: 20px;
        color: var(--secondary-text-color);
      }
      .social paper-button {
        border-radius: 25px;
        text-transform: none;
        font-size: 14px;
        margin-top: -35px;
      }
      .social .row .col span:not(:first-child) {
        color: var(--secondary-text-color);
      }
      .calendar,
      .ratings,
      .attachments,
      .administrators {
        padding: 0 20px;
      }

    </style>

    <app-route 
      route="{{route}}" 
      pattern="/show-campaign/:key" 
      data="{{data}}">
    </app-route>

    <firebase-document 
      id="document" 
      path="/campaigns/{{data.key}}" 
      data="{{campaign}}">
    </firebase-document>

    <firebase-storage-ref 
      download-url="{{coverImage}}"
      id="storage">
    </firebase-storage-ref>

    <firebase-query 
      id="follow"
      path="/users/{{user.uid}}/campaigns/{{data.key}}"
      data="{{follow}}">
    </firebase-query>

    <app-header-layout has-scrolling-region>
      <app-header slot="header" fixed condenses effects="waterfall resize-title blend-background parallax-background">
        <app-toolbar>
          <paper-icon-button icon="app:arrow-back" on-tap="_returnToCampaigns"></paper-icon-button>
          <h1 condensed-title class="dark title">{{campaign.content.candidateName}}</h1>
          <paper-icon-button icon="app:more-vert"></paper-icon-button>
        </app-toolbar>
        <app-toolbar class="tall">
          <h1 bottom-item main-title class="title">
            {{campaign.content.candidateName}}
          </h1>
          <campaign-player id="player" campaign-image="{{campaignImage}}" campaign="{{campaign.content}}" campaign-key="{{data.key}}">
          </campaign-player>
        </app-toolbar>
      </app-header>
      <div class="fill">
        <div class="candidate-info">
          <div class="details">
            <span>Brasília/DF</span>
            <span>Começou em: 05/06/18</span>
            <span>Partido: {{campaign.content.party}}</span>
          </div>
          <div class="support">
            <span>Apoiando</span>
            <paper-toggle-button on-change="_followCampaign"></paper-toggle-button>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col">
            <span>{{campaign.content.usersFollow.length}}</span>
            <span>total de apoiadores</span>
          </div>
          <div class="col">
            <span>321</span>
            <span>novos membros</span>
          </div>
          <div class="col">
            <span>321</span>
            <span>membros ativos</span>
          </div>
          <div class="col">
            <span>321</span>
            <span>missões concluídas</span>
          </div>
        </div>
        <hr>
        <div class="description">
          <p>{{campaign.content.description}}</p>
        </div>
      </div>
      <div class="social">
        <paper-button class="accent block" on-tap="">Biografia e propostas</paper-button>
        <div class="row">
          <div class="col">
            <a href="{{campaign.content.facebook}}" tabindex="-1" target="_blank">
              <paper-icon-button icon="app:share"></paper-icon-button>
            </a>
           <span>facebook</span>
          </div>
          <div class="col">
            <a href="{{campaign.content.twitter}}" tabindex="-1" target="_blank">
              <paper-icon-button icon="app:share"></paper-icon-button>
            </a>
            <span>twitter</span>
          </div>
          <div class="col">
            <a href="{{campaign.content.instagram}}" tabindex="-1" target="_blank">
              <paper-icon-button icon="app:share"></paper-icon-button>
            </a>
            <span>instagram</span>
          </div>
          <div class="col">
            <a href="{{campaign.content.website}}" tabindex="-1" target="_blank">
              <paper-icon-button icon="app:language"></paper-icon-button>
            </a>
            <span>website</span>
          </div>
        </div>
      </div>
      <div class="calendar">
        <h4>Próximos Eventos</h4>
      </div>
      <div class="ratings">
        <h4>Avaliações</h4>
      </div>
      <div class="attachments">
        <h4>Anexos</h4>
      </div>
      <div class="administrators">
        <h4>Administradores</h4>
      </div>
    </app-header-layout>

  </template>

  <script>
    class ShowCampaignPage extends Polymer.Element {
      static get is() { return 'show-campaign-page'; }
      static get properties() {
        return {
          selected: {
            observer: '_selectedChanged'
          },
          data: Object,
          campaign: {
            type: Object,
            observer: '_setCampaign'
          },
          follow: {
            type: Array
          },
          campaignImage: {
            type: String,
            observer: '_setLayerImage'
          }
        };
      }

      _selectedChanged(selected) {
        this._checkToggle();
         if (!selected) {
          this.$.player.stop();
          this.updateStyles({ '--layer-image': 'linear-gradient(to top, grey, grey)' });
        }
      }

      _returnToCampaigns() {
        this.set('route.path', '/campaigns');
      }

      _setCampaign(campaign) {
        //recover cover image just when exists
        if(!this.campaign || !this.campaign.content || !this.campaign.content.usersFollow) return;
        if(this.campaign.content.coverImage) {
          this.$.storage.path = `campaigns/${this.data.key}/${this.campaign.content.coverImage}`
        }
        //set toggle if user is following the campaign
        this._checkToggle();
      }

      _checkToggle() {
        const toggle = this.shadowRoot.querySelector('app-header-layout').querySelector('paper-toggle-button');
        if(!this.campaign.content) return;
        if(this.campaign.content.usersFollow.includes(this.user.uid)) {
          toggle.checked = true;
        } else {
          toggle.checked = false;
        }
      }

      openDrawer() {
        this.dispatchEvent(new CustomEvent('open-drawer'));
      }

      _followCampaign(e) {
        // get toogle state
        const follow = e.target.checked;
        if(follow) {
          const campaign = JSON.parse(JSON.stringify(this.campaign));
          delete campaign.content.usersFollow;
          this.$.follow.ref.set(campaign);
          const usersFollow = new Set(this.campaign.content.usersFollow);
          usersFollow.add(this.user.uid);
          this.campaign.content.usersFollow = Array.from(usersFollow);
          this.$.document.ref.set(this.campaign);
        } else {
          this._unfollowCampaign();
        }
      }

      _unfollowCampaign(e) {
        this.$.follow.ref.remove();
        const usersFollow = new Set(this.campaign.content.usersFollow);
        usersFollow.delete(this.user.uid);
        this.campaign.content.usersFollow = Array.from(usersFollow);
        this.$.document.ref.set(this.campaign);
      }

      _setLayerImage(campaignImage) {
        if (campaignImage && this.campaign.content) {
          this.updateStyles({ '--layer-image': `url(${campaignImage})` });
        }
      }
    }

    window.customElements.define(ShowCampaignPage.is, ShowCampaignPage);
  </script>
</dom-module>
