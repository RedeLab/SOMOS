<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/paper-stepper/paper-stepper.html">
<link rel="import" href="../../bower_components/paper-stepper/paper-step.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-storage-multiupload.html">

<link rel="import" href="../campaign-elements/proposal-dialog.html">
<link rel="import" href="../campaign-elements/social-dialog.html">
<link rel="import" href="../campaign-elements/create-campaign-dialog.html">
<link rel="import" href="../app-elements/app-dialog.html">
<link rel="import" href="../app-elements/app-form-header.html">
<link rel="import" href="../app-elements/shared-styles.html">
<link rel="import" href="../app-elements/app-icons.html">

<dom-module id="new-campaign-page">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        background: var(--secondary-background-color);
        height: 100vh;
        @apply --default-font;
      }
      app-form-header {
        color: var(--default-primary-color);
        background: var(--accent-color);
        --app-form-header-background: var(--accent-color);
        --app-form-header-color: var(--default-primary-color);
        @apply --default-font-medium;
      }
      paper-stepper {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: var(--secondary-background-color);  
      }
      .fill {
        flex: 1;
      }
      .step {
        padding: 0 20px;
        margin-bottom: 60px;
      }
      .step h1 {
        color: var(--secondary-text-color);
      }
      #step2 paper-fab {
        display: inline-block;
        position: absolute;
        right: 10%;
        top: 13%;
        background: var(--accent-color);
        color: var(--default-primary-color);
      }
      .input-file {
        background: var(--divider-color);
        margin: 30px 0 20px 0;
        padding: 10px 10px 20px 10px;
        border: 1px dashed var(--secondary-text-color);
        text-align: center;
      }
      .input-file iron-icon {
        --iron-icon-fill-color: var(--dark-primary-color);
        --iron-icon-height: 60px;
        --iron-icon-width: 60px;
        margin: 5px 0;
      }
      .input-file span {
        display: block;
        color: var(--secondary-text-color);
        font-size: 600;
      }
      .input-file .file {
        text-transform: uppercase;
        color: var(--accent-color);
      }
      .upload-button {
        position: relative;
      }
      label {
        color: var(--paper-input-container-color);
      }
      .links {
        margin-top: 5px;
      }
      .row {
        flex: 1;
      }
      .row span {
        display: inline-block;
        position: relative;
        background-color: white;
        width: calc(100% - 25px);
        height: 30px;
        margin: 5px 0;
        padding: 5px 10px;
        color: var(--secondary-text-color);
      }
      .row paper-icon-button {
        width: 35px;
        height: 35px;
        position: absolute;
        right: 0;
        top: 0;
      }
      paper-card {
        width: 100%;
        margin: 5px 0;
      }
      .card-title {
        padding: 10px;
      }
      .about {
        background-color: var(--accent-color);
        @apply --default-font-medium;
        color: var(--default-primary-color);
        height: 150px;
        position: relative;
        margin: 0 -20px;
      }
      .about h1 {
        padding: 10px 20px;;
        color: var(--default-primary-color);
        margin-top: 0;
      }
      .about .candidate-img {
        overflow: hidden;
        display: block;
        border-radius: 50%;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translate(-50%, 50%);
        height: 120px;
        width: 120px;
        background-color: var(--default-primary-color);
        border: 2px solid var(--accent-color);
      }
      .about .candidate-img input {
        position: absolute;
        opacity: 0;
        top: 0;
        left: 50%;
        transform: translate(-50%);
        width: 100%;
        height: 100%;
      }
      .about .candidate-img iron-image,
      .about iron-image {
        width: 100%;
        height: 100%;
      }
      .about .candidate-img iron-icon {
        position: absolute;
        bottom: 0;
        right: 50%;
        transform: translate(50%);
        --iron-icon-fill-color: var(--secondary-text-color);
      }
      .about .cover-img iron-icon {
        position: absolute;
        right: 5px;
        bottom: 5px;
      }
      .about .cover-img input {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 15%;
        opacity: 0;
        height: 30%;
      }
      .candidate {
        margin-top: 80px;
      }
      .candidate paper-dropdown-menu {
        width: 100%;
      }

    </style>

    <app-dialog id="confirm" opened="{{openedModal}}">
      <create-campaign-dialog></create-campaign-dialog>
    </app-dialog>

    <app-dialog id="dialog">
      <proposal-dialog on-create-proposal="_saveProposal" proposals="{{proposals}}"></proposal-dialog>
    </app-dialog>

    <app-dialog id="social">
      <social-dialog on-save-social="_saveSocialLink"></social-dialog>
    </app-dialog>

    <firebase-document
      id="document"
      data="{{campaignData}}">
    </firebase-document>

    <firebase-query
      id="proposal"
      path="/proposals/[[campaignId]]"
      data="{{proposalData}}">
    </firebase-query>

    <firebase-storage-multiupload 
      path="/campaigns/[[campaignId]]"
      files="[[fileArray]]"
      upload-tasks="{{uploadTasks}}"
      id="storage">
    </firebase-storage-multiupload>
    
    <app-header-layout has-scrolling-region>
      <app-form-header slot="header" shadow>
        <paper-icon-button slot="arrow-back" icon="app:back" on-tap="_returnToInbox"></paper-icon-button>
        <span slot="main-title">Criar Campanha</span>
        <paper-icon-button slot="more-vert" icon="app:more-vert"></paper-icon-button>
      </app-form-header>
      <div class="fill">
        <iron-pages selected="[[selection]]">
          <div class="step" id="step1">
            <div class="about">
              <iron-image sizing="cover" id="coverImage"></iron-image>
              <h1>Sobre o candidato</h1>
              <span class="cover-img">
                <iron-icon icon="app:add"></iron-icon>
                <input id="coverPhoto" type="file" on-change="getCoverPhoto" accept=".jpg, .jpeg, .png" value="{{campaign.coverImage}}">
              </span>
              <span class="candidate-img">
                <iron-image sizing="cover" id="candidateImage"></iron-image>
                <iron-icon icon="app:add"></iron-icon>
                <input id="candidatePhoto" type="file" on-change="getCandidatePhoto" accept=".jpg, .jpeg, .png" value="{{campaign.candidateImage}}">
              </span>
            </div>
            <div class="candidate">
              <paper-input label="Nome do candidato" placeholder="Nome do candidato" value="{{campaign.candidateName}}"></paper-input>
              <paper-dropdown-menu label="Cargo que irá disputar" value="{{campaign.role}}">
                <paper-listbox slot="dropdown-content" class="dropdown-content">
                  <paper-item>Presidente</paper-item>
                  <paper-item>Governador</paper-item>
                  <paper-item>Senador</paper-item>
                  <paper-item>Deputado Federal</paper-item>
                  <paper-item>Deputado Estadual</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-dropdown-menu label="Estado" value="{{campaign.state}}">
                <paper-listbox slot="dropdown-content" class="dropdown-content">
                  <paper-item>Estado 1</paper-item>
                  <paper-item>Estado 2</paper-item>
                  <paper-item>Estado 3</paper-item>
                  <paper-item>Estado 4</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-input label="Cidade" placeholder="Digite o nome da cidade" value="{{campaign.city}}"></paper-input>
              <paper-input label="Título de eleitor" placeholder="XXXXXX-XXX" value="{{campaign.voter}}"></paper-input>
              <paper-dropdown-menu label="Escolha o partido" value="{{campaign.party}}">
                <paper-listbox slot="dropdown-content" class="dropdown-content">
                  <paper-item>Rede</paper-item>
                  <paper-item>Outro</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-input label="Número de filiação do partido" placeholder="XXXXXX-XXX" value="{{campaign.membership}}"></paper-input>
            </div>
          </div>
          <div class="step" id="step2">
            <h1>Propostas
              <paper-fab mini icon="app:add" on-tap="open"></paper-fab>
            </h1>
            <template is="dom-repeat" items="{{proposalData}}">
              <paper-card>
                <div class="card-title">{{item.content.title}}</div>
              </paper-card>
            </template>
          </div>
          <div class="step" id="step3">
            <h1>Dados da campanha</h1>
            <div class="fields">
              <paper-input value="{{campaign.name}}" label="Titulo" placeholder="Nome da campanha"></paper-input>
              <paper-textarea value="{{campaign.description}}" label="Descrição" placeholder="Uma breve descrição da campanha" char-counter
                maxlength="500"></paper-textarea>
              <div class="input-file">
                <iron-icon icon="app:cloud-upload"></iron-icon>
                <span>Faça o upload de imagens, vídeos ou aúdios que apoiem a sua descrição de campanha.</span>
                <div class="upload-button">
                  <span class="file">Selecionar arquivo</span>
                  <input type="file" multiple>
                </div>
              </div>
              <paper-input value="{{campaign.calling}}" label="Rótulo do botão de chamada" placeholder="Vamos fazer juntos a diferença?"></paper-input>
              <label>Links externos</label>
              <div class="links">
                <div class="row">
                  <span>Website: {{campaign.website}}
                    <paper-icon-button icon="app:edit" on-tap="openSocial" name="website"></paper-icon-button>
                  </span>
                  <span>Facebook: {{campaign.facebook}}
                    <paper-icon-button icon="app:edit" on-tap="openSocial" name="facebook"></paper-icon-button>
                  </span>
                </div>
                <div class="row">
                  <span>Instagram: {{campaign.instagram}}
                    <paper-icon-button icon="app:edit" on-tap="openSocial" name="instagram"></paper-icon-button>
                  </span>
                  <span>Twitter: {{campaign.twitter}}
                    <paper-icon-button icon="app:edit" on-tap="openSocial" name="twitter"></paper-icon-button>
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div></div>
        </iron-pages>
        <paper-stepper selected="{{selection}}" progress-bar back-label="Voltar" next-label="{{nextLabel}}">
          <paper-step></paper-step>
          <paper-step></paper-step>
          <paper-step></paper-step>
          <paper-step></paper-step>
        </paper-stepper>
      </div>
    </app-header-layout>
  </template>
  <script>
    class NewCampaignPage extends Polymer.Element {
      static get is() { return 'new-campaign-page'; }
      static get properties() {
        return {
          route: {
            type: Object,
            notify: true
          },
          selected: {
            observer: '_selectedChanged'
          },
          campaign: {
            type: Object,
            value: function () { return {}; }
          },
          campaignData: {
            type: Object,
            value: function () { return {}; }
          },
          selection: {
            type: Number,
            observer: '_setCreateCampaign'
          },
          nextLabel: {
            type: String,
            value: 'Próximo'
          },
          openedModal: {
            type: Boolean,
            observer: '_observeModal'
          },
          fileArray: {
            type: Array,
            value: []
          },
          uploadTasks: {
            type: Array,
            value: []
          },
          campaignId: {
            type: String
          },
          proposals: {
            type: Array
          }
        };
      }

      _selectedChanged(selected) {
        if (!selected) return;
      }

      _returnToInbox() {
        this.set('route.path', '/');
      }

      open() {
        this.$.dialog.present();
      }

      openSocial(e) {
        this.$.social.present();
        this.$.social.socialMedia = e.target.getAttribute('name');
        
      }

      _saveSocialLink(e) {
        const data = e.detail;
        this.set(`campaign.${this.$.social.socialMedia}`, data.link);
        this.$.social.dismiss();
      }

      getCandidatePhoto(e) {
        let photo = e.target.files[0];
        if(photo) {
          let reader = new FileReader();
          const img = this.$.candidateImage;
          reader.onload = function (e) {
            img.src = e.target.result;
          }
          reader.readAsDataURL(photo);
        }
      }
        
      getCoverPhoto(e) {
        let photo = e.target.files[0];
        if (photo) {
          let reader = new FileReader();
          const img = this.$.coverImage;
          reader.onload = function (e) {
            img.src = e.target.result;
          }
          reader.readAsDataURL(photo);
        }
      }

      _saveCampaign(e) {
        this.campaign.uid = this.user.uid;
        console.log(this.campaign);
        console.log(this.proposals);
        //save campaign
        if(this.campaignId) {
          this.$.document.path = `/campaigns/${this.campaignId}`;
          this.campaignData = { content: this.campaign };
        } else {
          this.campaignData = { content: this.campaign };
          this.$.document.saveValue('/campaigns').then(function() {
            this.campaignId = this.$.document.path.match(/\/.*\/(.*)/)[1];
          }.bind(this));
        }
        //upload images
        this._uploadImages();
      }

      _uploadImages() {
        if(this.$.coverPhoto.files[0]) {
          this.campaign.coverImage = this.$.coverPhoto.files[0].name;
          this.fileArray.push(this.$.coverPhoto.files[0]);
        }
        if(this.$.candidatePhoto.files[0]) {
          this.campaign.candidateImage = this.$.candidatePhoto.files[0].name;
          this.fileArray.push(this.$.candidatePhoto.files[0]);
        }
        if(this.campaignId) {
          this.$.storage.upload();
        }
      }
      
      _saveProposal(e) {
        const proposal = e.detail.proposal;
        this.$.proposal.ref.push({ content: proposal });
      }

      _setCreateCampaign(selection) {
        if(!selection) return;
        // this._saveCampaign();
        if(selection === 2) {
          this.nextLabel = 'Concluir';
        } else if(selection === 3) {
          this.$.confirm.present();
        } else {
          this.nextLabel = 'Próximo';
        }
      }

      _observeModal() {
        if (!this.openedModal) {
          this._returnToInbox();
          this.selection = 0;
          this.campaign = {};
          this.campaignId = undefined;
          this.fileArray= [];
        }
      }

    }
    window.customElements.define(NewCampaignPage.is, NewCampaignPage);
  </script>
</dom-module>
